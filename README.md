# FundMe - Decentralized Crowdfunding Contract

A production-ready Solidity smart contract built with Foundry that enables decentralized crowdfunding with USD-denominated minimum contributions powered by Chainlink Price Feeds.

## Overview

FundMe is a crowdfunding smart contract that accepts ETH donations while enforcing a minimum contribution value in USD. By integrating with Chainlink Price Feeds, the contract ensures that regardless of ETH price volatility, all contributions meet the $5 USD minimum threshold.

**Core Functionality:**
- ✅ Accepts ETH donations with a minimum $5 USD value requirement
- ✅ Uses Chainlink Price Feeds for real-time ETH/USD conversion
- ✅ Owner-only withdrawal with gas-optimized implementation
- ✅ Automatic fallback/receive functions for direct ETH transfers
- ✅ Supports deployment across multiple networks (Mainnet, Sepolia, Anvil)
- ✅ Comprehensive test coverage with unit and integration tests

## Key Features

### 💰 USD-Denominated Minimums
Ensures contributions meet a $5 minimum regardless of ETH price fluctuations, providing consistent value requirements.

### 🌐 Multi-Network Support
Automatically configures for Ethereum Mainnet, Sepolia testnet, or local Anvil using `block.chainid` detection. No code changes needed for different networks.

### ⚡ Gas-Optimized Withdrawals
Two withdrawal implementations demonstrate gas optimization techniques:
- `withdraw()`: Standard implementation
- `cheaperWithdraw()`: Optimized version (~800 gas savings per funder)

### 🧪 Comprehensive Testing
- Unit tests covering all contract functions
- Integration tests for full deployment workflows
- Fork tests for mainnet/testnet validation
- Gas comparison tests

### 🤖 Automated Interactions
Scripts for post-deployment operations:
- `FundFundMe`: Fund contracts with 0.1 ETH
- `WithdrawFundMe`: Owner withdrawals
- Uses `foundry-devops` to locate most recent deployments

## Prerequisites

- [Foundry](https://book.getfoundry.sh/getting-started/installation) installed
- Basic understanding of Solidity and smart contracts

## Installation

1. Clone the repository:
```bash
git clone <your-repo-url>
cd foundry-fund-me
```

2. Install dependencies:
```bash
forge install
```

3. Create a `.env` file (optional, for testnet/mainnet deployment):
```bash
SEPOLIA_RPC_URL=your_sepolia_rpc_url
MAINNET_RPC_URL=your_mainnet_rpc_url
PRIVATE_KEY=your_private_key
ETHERSCAN_API_KEY=your_etherscan_api_key
```
## ⚠️THE MOST IMPORTANT NOTE IN THIS README ⚠️
Never put your private key in your .env file!
Your .env file should only ever contain test keys (like those generated by Anvil for local testing).

Even then, I strongly recommend using a keystore instead of storing private keys in plain text.
You can learn how to create and use a keystore here:
👉[How to encrypt the private key in a keystore file in Foundry](https://ethereum.stackexchange.com/questions/158784/how-to-encrypt-the-private-key-in-a-keystore-file-in-foundry)


Practice this habit early — make it second nature.
Never put your private key in .env files or command lines in plain text, ever.

For emphasis, watch Patrick from Cyfrin Updraft explain why this matters:
🎥 [Never Use a .env File — Cyfrin Updraft](https://updraft.cyfrin.io/courses/foundry/foundry-simple-storage/never-use-a-env-file)
 
## Usage

### Build

Compile the smart contracts:
```bash
forge build
```

### Test

Run all tests:
```bash
forge test
```

Run tests with detailed output:
```bash
forge test -vvv
```

Run tests on Sepolia fork:
```bash
forge test --fork-url $SEPOLIA_RPC_URL
```

Run specific test file:
```bash
forge test --match-path test/unit/FundMeTest.t.sol
```

### Deploy

Deploy to local Anvil:
```bash
# Terminal 1: Start Anvil
anvil

# Terminal 2: Deploy
forge script script/DeployFundMe.s.sol --rpc-url http://localhost:8545 --private-key <anvil_private_key> --broadcast
```

Deploy to Sepolia testnet:
```bash
forge script script/DeployFundMe.s.sol --rpc-url $SEPOLIA_RPC_URL --private-key $PRIVATE_KEY --broadcast --verify --etherscan-api-key $ETHERSCAN_API_KEY
```

### Interact with Deployed Contract

Fund a deployed contract:
```bash
forge script script/Interactions.s.sol:FundFundMe --rpc-url <rpc_url> --private-key <private_key> --broadcast
```

Withdraw funds (owner only):
```bash
forge script script/Interactions.s.sol:WithdrawFundMe --rpc-url <rpc_url> --private-key <private_key> --broadcast
```

### Format Code

```bash
forge fmt
```

### Gas Snapshots

Generate gas usage report:
```bash
forge snapshot
```

## Project Structure

```
foundry-fund-me/
├── src/
│   ├── FundMe.sol              # Main crowdfunding contract (126 lines)
│   └── PriceConverter.sol      # Library for ETH/USD conversions (31 lines)
├── script/
│   ├── DeployFundMe.s.sol      # Main deployment script (21 lines)
│   ├── HelperConfig.s.sol      # Multi-network configuration manager (65 lines)
│   └── Interactions.s.sol      # Fund/Withdraw interaction scripts (42 lines)
├── test/
│   ├── unit/
│   │   └── FundMeTest.t.sol              # Comprehensive unit tests (196 lines)
│   ├── integration/
│   │   └── FundMeTestIntegration.t.sol   # End-to-end integration tests (50 lines)
│   └── mocks/
│       └── MockV3Aggregator.sol          # Mock Chainlink price feed (100 lines)
├── lib/                        # Dependencies
│   ├── chainlink-brownie-contracts/      # Chainlink interfaces (v1.1.1)
│   ├── forge-std/                        # Foundry testing library (v1.8.2)
│   └── foundry-devops/                   # DevOps tools (v0.2.2)
├── foundry.toml                # Foundry configuration
├── Makefile                    # Convenient command shortcuts
└── CLAUDE.md                   # Detailed project documentation for AI assistants
```

## Smart Contract Architecture

### FundMe.sol
**Main crowdfunding contract** ([src/FundMe.sol](src/FundMe.sol))

**State Variables:**
- `s_addressToAmountFunded`: Mapping tracking contribution amounts per address
- `s_funders`: Array of all funder addresses
- `i_owner`: Immutable owner address (set at deployment)
- `s_priceFeed`: Chainlink AggregatorV3Interface instance
- `MINIMUM_USD`: Constant minimum contribution (5e18 = $5 USD)

**Key Functions:**
- `fund()`: Accept ETH donations, enforce $5 minimum, track funders
- `withdraw()`: Owner-only function to withdraw all funds (standard)
- `cheaperWithdraw()`: Gas-optimized withdrawal (reads array length to memory)
- `fallback()` & `receive()`: Automatically route plain ETH to `fund()`
- `getVersion()`: Returns Chainlink price feed version

**Access Control:**
- `onlyOwner` modifier restricts withdrawals to contract owner
- Custom error `FundMe__NotOwner()` for gas-efficient reverts

**Naming Conventions:**
- `s_` prefix: Storage variables
- `i_` prefix: Immutable variables
- `UPPER_CASE`: Constants

### PriceConverter.sol
**Library for price conversions** ([src/PriceConverter.sol](src/PriceConverter.sol))

**Functions:**
- `getPrice(AggregatorV3Interface priceFeed)`: Fetches current ETH/USD price
  - Queries Chainlink oracle via `latestRoundData()`
  - Returns price with 18 decimal places (adjusts from 8)
- `getConversionRate(uint256 ethAmount, AggregatorV3Interface priceFeed)`: Converts ETH to USD
  - Used via library attachment: `msg.value.getConversionRate(s_priceFeed)`
  - Returns USD value with 18 decimals

**Design Pattern:**
- Attached to `uint256` via `using PriceConverter for uint256`
- All functions are `internal` (no public interface)
- Handles decimal precision conversions automatically

### HelperConfig.s.sol
**Multi-network configuration manager** ([script/HelperConfig.s.sol](script/HelperConfig.s.sol))

**Network Support:**
- **Sepolia (chainid 11155111)**: Uses live Chainlink ETH/USD feed
  - Address: `0x694AA1769357215DE4FAC081bf1f309aDC325306`
- **Mainnet (chainid 1)**: Uses live Chainlink ETH/USD feed
  - Address: `0x5f4eC3Df9cbd43714FE2740f5E3616155c5b8419`
- **Anvil/Local (chainid 31337)**: Deploys `MockV3Aggregator`
  - 8 decimals, initial price $2000

**Architecture:**
- Auto-detects network via `block.chainid`
- Returns `NetworkConfig` struct with price feed address
- Caches mock deployments to avoid duplication
- Mock deployment occurs within `vm.startBroadcast()` for on-chain deployment

### DeployFundMe.s.sol
**Main deployment script** ([script/DeployFundMe.s.sol](script/DeployFundMe.s.sol))

**Deployment Flow:**
1. Creates `HelperConfig` to get network-specific price feed
2. Starts broadcast (`vm.startBroadcast()`)
3. Deploys `FundMe` contract with price feed address
4. Stops broadcast (`vm.stopBroadcast()`)
5. Returns deployed FundMe instance

**Key Pattern:** Code before `startBroadcast()` runs locally; code between start/stop is broadcast as transactions.

### Interactions.s.sol
**Post-deployment interaction scripts** ([script/Interactions.s.sol](script/Interactions.s.sol))

**FundFundMe Contract:**
- Funds most recently deployed FundMe with 0.1 ETH
- Uses `DevOpsTools.get_most_recent_deployment()` to locate contract
- Provides console logs for transaction confirmation

**WithdrawFundMe Contract:**
- Withdraws all funds from most recently deployed FundMe
- Owner-only operation (enforced by FundMe contract)
- Same deployment lookup pattern

## Key Concepts Demonstrated

- Using Chainlink Price Feeds for external data
- Library pattern for code reusability
- Multi-network deployment strategy with mocks
- Custom errors for gas efficiency
- Modifier pattern for access control
- Foundry testing best practices
- Gas optimization techniques

## Testing

The project includes comprehensive tests covering all functionality:

### Unit Tests ([test/unit/FundMeTest.t.sol](test/unit/FundMeTest.t.sol))
Tests individual contract functions in isolation:

**Setup:**
- Deploys via `DeployFundMe` script
- Creates test address "alice" with 10 ETH
- Uses `funded` modifier for common funded state

**Test Coverage:**
- ✅ `testMinimumDollarIsFive()`: Validates constant value
- ✅ `testOwnerIsMsgSender()`: Confirms deployer ownership
- ✅ `testPriceFeedVersionIsAccurate()`: Verifies Chainlink integration
- ✅ `testFundFailsWIthoutEnoughETH()`: Enforces $5 minimum with `vm.expectRevert()`
- ✅ `testFundUpdatesFundDataStructure()`: Validates mapping updates
- ✅ `testAddsFunderToArrayOfFunders()`: Confirms array tracking
- ✅ `testOnlyOwnerCanWithdraw()`: Non-owner rejection
- ✅ `testWithdrawFromASingleFunder()`: Single funder withdrawal + gas tracking
- ✅ `testWithdrawFromMultipleFunders()`: Multiple funders, standard withdrawal
- ✅ `testWithdrawFromMultipleFundersCheaper()`: Gas-optimized comparison

**Testing Patterns Used:**
- `vm.prank()`: Simulate transactions from specific addresses
- `vm.deal()`: Give test addresses ETH
- `hoax()`: Combined prank + deal
- `vm.expectRevert()`: Verify failed transactions
- `vm.txGasPrice()` + `gasleft()`: Gas consumption measurement
- `makeAddr()`: Generate deterministic test addresses

### Integration Tests ([test/integration/FundMeTestIntegration.t.sol](test/integration/FundMeTestIntegration.t.sol))
End-to-end workflow testing:

**Test Flow:**
1. Deploy FundMe via script
2. Alice funds contract with 0.1 ETH
3. Owner runs `WithdrawFundMe` script
4. Verify contract balance is zero
5. Verify owner balance increased
6. Uses `assertApproxEqAbs()` for gas cost tolerance (~1e12 wei)

### Fork Tests
Test against live network state:
```bash
forge test --fork-url $SEPOLIA_RPC_URL
```

All tests pass on local Anvil, Sepolia fork, and mainnet fork environments.

## Gas Optimization

The contract demonstrates gas optimization techniques with two withdrawal implementations:

### Standard Withdrawal
```solidity
function withdraw() public onlyOwner {
    for (uint256 i = 0; i < s_funders.length; i++) {
        // Accesses s_funders.length every iteration (SLOAD each time)
    }
}
```

### Optimized Withdrawal
```solidity
function cheaperWithdraw() public onlyOwner {
    uint256 fundersLength = s_funders.length;  // Single SLOAD
    for (uint256 i = 0; i < fundersLength; i++) {
        // Uses memory variable (saves ~800 gas per funder)
    }
}
```

**Gas Savings:** ~800 gas per funder by reading array length into memory before the loop.

**Compare gas usage:**
```bash
forge snapshot
forge test --gas-report
```

## Dependencies

### Core Libraries
- **[forge-std](https://github.com/foundry-rs/forge-std) (v1.8.2)**: Foundry standard library
  - Provides `Test` base class with assertions and cheatcodes
  - `Script` base class for deployment scripts
  - Console logging utilities
  - VM utilities for testing

- **[chainlink-brownie-contracts](https://github.com/smartcontractkit/chainlink-brownie-contracts) (v1.1.1)**: Chainlink interfaces
  - `AggregatorV3Interface` for price feeds
  - Production-ready oracle integration
  - Used for ETH/USD price conversions

- **[foundry-devops](https://github.com/Cyfrin/foundry-devops) (v0.2.2)**: DevOps tools
  - `DevOpsTools.get_most_recent_deployment()` finds deployed contracts
  - Reads from broadcast files automatically
  - Simplifies interaction scripts

### Installation
All dependencies are managed via Foundry and installed as git submodules:
```bash
forge install
```

## Advanced Usage

### Using Cast for Direct Interaction

Query contract state:
```bash
# Get owner address
cast call <CONTRACT_ADDRESS> "getOwner()" --rpc-url <RPC_URL>

# Get minimum USD
cast call <CONTRACT_ADDRESS> "MINIMUM_USD()" --rpc-url <RPC_URL>

# Get contract balance
cast balance <CONTRACT_ADDRESS> --rpc-url <RPC_URL>

# Get price feed version
cast call <CONTRACT_ADDRESS> "getVersion()" --rpc-url <RPC_URL>
```

Send transactions:
```bash
# Fund contract with 0.1 ETH
cast send <CONTRACT_ADDRESS> "fund()" \
  --value 0.1ether \
  --private-key <PRIVATE_KEY> \
  --rpc-url <RPC_URL>

# Withdraw funds (owner only)
cast send <CONTRACT_ADDRESS> "withdraw()" \
  --private-key <PRIVATE_KEY> \
  --rpc-url <RPC_URL>
```

Convert units:
```bash
cast --to-wei 0.1ether      # Convert to wei
cast --from-wei 100000000000000000  # Convert from wei
```

### Makefile Commands

The project includes a Makefile with convenient shortcuts:

```bash
make test           # Run all tests
make test-fork      # Run tests on Sepolia fork
make build          # Compile contracts
make snapshot       # Generate gas snapshots
make format         # Format code
make anvil          # Start local Anvil node
make deploy         # Deploy to local network
make install        # Install dependencies
```

### Viewing Storage Layout

Analyze contract storage:
```bash
forge inspect FundMe storage-layout
```

View storage in tests:
```bash
forge test --match-test testPrintStorageData -vvvv
```

## Configuration

### foundry.toml
```toml
[profile.default]
src = "src"
out = "out"
libs = ["lib"]
remappings = [
    "@chainlink/contracts/=lib/chainlink-brownie-contracts/contracts/"
]

# Optimizer settings
optimizer = true
optimizer_runs = 200
```

### Environment Variables
Create a `.env` file:
```bash
SEPOLIA_RPC_URL=https://eth-sepolia.g.alchemy.com/v2/YOUR_API_KEY
MAINNET_RPC_URL=https://eth-mainnet.g.alchemy.com/v2/YOUR_API_KEY
PRIVATE_KEY=your_private_key_here
ETHERSCAN_API_KEY=your_etherscan_api_key
```

Load environment variables:
```bash
source .env
```

## Architecture Patterns

### Custom Errors
Gas-efficient error handling:
```solidity
error FundMe__NotOwner();
if (msg.sender != i_owner) revert FundMe__NotOwner();
```
Saves ~50 gas compared to `require(msg.sender == i_owner, "Not owner")`

### Library Pattern
Code reusability via libraries:
```solidity
using PriceConverter for uint256;
// Enables: msg.value.getConversionRate(priceFeed)
```

### Multi-Network Deployment
Single codebase for all networks:
```solidity
if (block.chainid == 11155111) {
    // Sepolia config
} else if (block.chainid == 1) {
    // Mainnet config
} else {
    // Deploy mocks for local
}
```

### Immutable Variables
Gas savings for constants set at construction:
```solidity
address private immutable i_owner;
// SLOAD costs 100 gas, direct access costs 3 gas
```

## Common Issues & Solutions

### Issue: "Mock already deployed"
**Solution:** The HelperConfig caches mock deployments. Restart Anvil or use a fresh deployment.

### Issue: Insufficient funds for gas
**Solution:** Ensure test addresses have enough ETH. Use `vm.deal()` or `hoax()` in tests.

### Issue: Price feed version mismatch
**Solution:** Verify you're using the correct Chainlink price feed address for your network.

### Issue: Tests fail on fork
**Solution:** Ensure your RPC URL is correct and has archive node access for historical data.

## Security Considerations

This is an educational project. For production use, consider:

1. **Reentrancy Protection**: Add `ReentrancyGuard` from OpenZeppelin
2. **Pause Mechanism**: Implement emergency pause functionality
3. **Time Locks**: Add withdrawal time delays for large amounts
4. **Multi-sig**: Use multi-signature wallet for owner operations
5. **Upgrade Patterns**: Consider proxy patterns for upgradeability
6. **Audit**: Get professional security audit before mainnet deployment

## Contributing

Contributions are welcome! Please:
1. Fork the repository
2. Create a feature branch
3. Add tests for new functionality
4. Ensure all tests pass (`forge test`)
5. Submit a pull request

## Resources

- [Foundry Book](https://book.getfoundry.sh/) - Complete Foundry documentation
- [Chainlink Price Feeds](https://docs.chain.link/data-feeds/price-feeds/addresses) - Price feed addresses for all networks
- [Solidity Documentation](https://docs.soliditylang.org/) - Official Solidity docs
- [Cyfrin Updraft](https://updraft.cyfrin.io/) - Foundry course materials
- [OpenZeppelin Contracts](https://docs.openzeppelin.com/contracts/) - Production-ready contract libraries

## License

MIT

---

**Built with Foundry** | **Powered by Chainlink** | **Educational Project**
